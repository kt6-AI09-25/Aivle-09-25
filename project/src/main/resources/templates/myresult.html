<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>분석 결과 및 평가 기록</title>
    <!-- 기존 style.css -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/myresult.css">


    <style>
        /* 이미 myresult.css에 .no-videos-message가 있다면, 그대로 적용해도 좋습니다.
           폰트 크기는 필요시 조정 가능합니다. */
        .no-videos-message {
            text-align: center;
            color: #666666;
            margin: 20px 0;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
<!-- 네비게이션 (Thymeleaf include) -->
<div th:replace="navbar.html"></div>

<!-- 분석 결과 영역 (프론트엔드 담당 코드) -->
<main>
    <section class="content">
        <div class="centered-content analysis-section">
            <h1 class="analysis-result">분석결과</h1>
            <div class="analysis-line"></div>
            <!-- 발표영상, 면접영상 선택 버튼 -->
            <div class="button-container">
                <!-- 기본 로딩 시 발표영상 버튼이 active-button 클래스가 되도록 설정 -->
                <button class="mui-button active-button" id="presentationVideoButton">발표영상</button>
                <button class="mui-button" id="interviewVideoButton">면접영상</button>
            </div>
        </div>

        <!-- 썸네일 컨테이너 -->
        <div class="thumbnail-container">
            <!-- 발표영상 섹션 -->
            <div id="presentationVideos">
                <!-- 영상 데이터가 있을 때 썸네일들을 출력 -->
                <div th:if="${presentationVideos != null and !#lists.isEmpty(presentationVideos)}">
                    <div th:each="video, iterStat : ${presentationVideos}">
                        <img th:if="${video.thumbnailUrl != null}"
                             th:src="@{${video.thumbnailUrl}}"
                             alt="발표영상 썸네일"
                             th:attr="data-videoUrl=${video.videoUrl}"
                             class="video-thumbnail" />
                        <!-- 한 행에 3개씩 정렬: 3번째 요소마다 clear -->
                        <div th:if="${iterStat.index % 3 == 2}" style="clear: both;"></div>
                    </div>
                </div>
                <!-- 영상 데이터가 없을 경우 메시지 출력 -->
                <div th:if="${presentationVideos == null or #lists.isEmpty(presentationVideos)}">
                    <!-- h1 태그로 가운데 정렬 & #666666 색상 적용 -->
                    <h1 class="no-videos-message">저장된 발표영상이 없습니다.</h1>
                    <!-- 임시로 모달 열기 버튼 -->
                    <div style="text-align: center; margin: 20px 0;">
                        <button type="button" class="mui-button" onclick="openAnalysisModal()">
                            결과모달 열기 (임시)
                        </button>
                    </div>
                </div>
            </div>

            <!-- 면접영상 섹션 -->
            <div id="interviewVideos" style="display: none;">
                <!-- 영상 데이터가 있을 때 썸네일들을 출력 -->
                <div th:if="${interviewVideos != null and !#lists.isEmpty(interviewVideos)}">
                    <div th:each="video, iterStat : ${interviewVideos}">
                        <img th:if="${video.thumbnailUrl != null}"
                             th:src="@{${video.thumbnailUrl}}"
                             alt="면접영상 썸네일"
                             th:attr="data-videoUrl=${video.videoUrl}"
                             class="video-thumbnail" />
                        <div th:if="${iterStat.index % 3 == 2}" style="clear: both;"></div>
                    </div>
                </div>
                <!-- 영상 데이터가 없을 경우 메시지 출력 -->
                <div th:if="${interviewVideos == null or #lists.isEmpty(interviewVideos)}">
                    <h1 class="no-videos-message">저장된 면접영상이 없습니다.</h1>
                    <!-- 임시로 모달 열기 버튼 -->
                    <div style="text-align: center; margin: 20px 0;">
                        <button type="button" class="mui-button" onclick="openAnalysisModal()">
                            결과모달 열기 (임시)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="spacer"></div>

        <!-- 분석 결과 모달 -->
        <div id="videoModal" class="modal" role="dialog" aria-modal="true">
            <div class="modal-content" tabindex="-1">
                <button class="modal-close" id="analysisModalClose" aria-label="Close analysis modal">&times;</button>
                <div class="module-titleArea">
                    <h1>분석 결과</h1>
                </div>
                <div class="menu-bar" id="menuBar1">
                    <a href="#" id="summaryResult" class="active">종합결과</a>
                    <a href="#" id="detailAnalysis">세부분석</a>
                </div>

                <!-- 종합결과 -->
                <div id="summaryContent" class="summary-content">
                    <p>이곳은 종합결과를 보여주는 영역입니다.</p>
                </div>

                <!-- 세부분석 -->
                <div id="detailContent" class="detail-content">
                    <div class="menu-bar hidden" id="menuBar2">
                        <a href="#" id="motion" class="active">모션점수</a>
                        <a href="#" id="voice">표정점수</a>
                        <a href="#" id="gaze">언어점수</a>
                    </div>
                    <div class="modal-body split">
                        <div class="modal-left">
                            <!-- 모달 왼쪽에 표시될 영상 -->
                            <video controls id="analysisVideo">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div class="modal-right">
                            <div class="frame-card">
                                <div id="motionContent" class="motion-content active">
                                    <p>모션 평가 내용이 여기에 표시됩니다.</p>
                                </div>
                                <div id="voiceContent" class="voice-content">
                                    <p>표정 평가 내용이 여기에 표시됩니다.</p>
                                </div>
                                <div id="gazeContent" class="gaze-content">
                                    <p>언어 평가 내용이 여기에 표시됩니다.</p>
                                    <div class="chart-container">
                                        <canvas id="gazeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 평가 기록 영역 (백엔드 담당 코드) -->
    <section>
        <h1>이전 평가 기록</h1>
        <div th:each="score : ${previousScores}" class="video-container">
            <div class="video-thumbnail" th:attr="data-scoreid=${score.scoreId}" onclick="openScoreModal(this)">
                <video width="300" height="180"
                       th:src="@{/myresults/upload/results/{fileId}(fileId=${score.fileName})}"
                       poster="/video/recorded_thumbnail.jpg" controls>
                </video>
            </div>
            <p><strong>날짜:</strong> <span th:text="${#temporals.format(score.date, 'yyyy-MM-dd HH:mm')}"></span></p>
            <p><strong>작성자:</strong> <span th:text="${score.userId}"></span></p>
        </div>

        <h1>현재 평가 중</h1>
        <div th:if="${evaluatingScore != null}" class="video-container">
            <div class="video-thumbnail" th:if="${evaluatingScore.status == 'IN_PROGRESS'}">
                <span class="loading">평가 진행 중...</span>
            </div>
            <div class="video-thumbnail" th:if="${evaluatingScore.status == 'COMPLETED' or evaluatingScore.fileId != null}"
                 th:attr="data-scoreid=${evaluatingScore.scoreId}" onclick="openScoreModal(this)">
                <video width="300" height="180"
                       th:src="@{/myresults/upload/results/{fileId}(fileId=${evaluatingScore.fileId})}"
                       poster="/video/recorded_thumbnail.jpg" controls>
                </video>
            </div>
            <p><strong>날짜:</strong> <span th:text="${#temporals.format(evaluatingScore.date, 'yyyy-MM-dd HH:mm')}"></span></p>
            <p><strong>작성자:</strong> <span th:text="${evaluatingScore.userId}"></span></p>
        </div>
    </section>
</main>

<!-- 평가 상세 모달 (Score Modal) -->
<div id="commonModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content" tabindex="-1">
        <button class="modal-close" id="scoreModalClose" aria-label="Close score modal">✖</button>
        <video id="modalVideo" controls></video>
        <div class="score-details">
            <h3>총 점수: <span id="modalTotalScore"></span></h3>
            <p>움직임 점수: <span id="modalMotionScore"></span></p>
            <p>표정 점수: <span id="modalExpressionScore"></span></p>
            <p>언어 점수: <span id="modalLanguageScore"></span></p>
            <p>속도: <span id="modalTempo"></span></p>
            <p>날짜: <span id="modalDate"></span></p>
            <h4>머리 움직임 시간대</h4>
            <ul id="motionTimesList"></ul>
            <h4>표정 변화 시간대</h4>
            <ul id="expressionTimesList"></ul>
            <h4>언어 사용 시간대</h4>
            <ul id="languageTimesList"></ul>
        </div>
    </div>
</div>

<!-- 푸터 (Thymeleaf include) -->
<div th:replace="footer.html"></div>

<!-- 외부 Chart.js 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- 스크립트 (분석 결과 및 평가 기록 영역 기능 포함) -->
<script>
    /***** 분석 결과 영역 (프론트엔드) *****/
    const analysisModal = document.getElementById('videoModal');
    const summaryContent = document.getElementById('summaryContent');
    const detailContent = document.getElementById('detailContent');
    const menuBar2 = document.getElementById('menuBar2');
    const detailAnalysis = document.getElementById('detailAnalysis');
    const summaryResult = document.getElementById('summaryResult');
    const analysisModalClose = document.getElementById('analysisModalClose');
    const motionButton = document.getElementById('motion');
    const voiceButton = document.getElementById('voice');
    const gazeButton = document.getElementById('gaze');
    const motionContent = document.getElementById('motionContent');
    const voiceContent = document.getElementById('voiceContent');
    const gazeContent = document.getElementById('gazeContent');
    const gazeChartElement = document.getElementById('gazeChart');
    const analysisVideo = document.getElementById('analysisVideo');

    let gazeChartInstance = null;

    const presentationVideoButton = document.getElementById('presentationVideoButton');
    const interviewVideoButton = document.getElementById('interviewVideoButton');
    const presentationVideos = document.getElementById('presentationVideos');
    const interviewVideos = document.getElementById('interviewVideos');

    // 이미 HTML에서 발표영상 버튼에 active-button 클래스를 추가했으므로
    // 화면이 로드되었을 때 발표영상이 디폴트로 표시됨.
    // 아래 로직 또한 '처음 로딩 시' 발표영상 버튼을 활성화 상태로 두기 위함
    // (필요에 따라 중복 여부 확인 후 제거 가능)
    presentationVideoButton.classList.add('active-button');
    presentationVideos.style.display = 'block';
    interviewVideos.style.display = 'none';

    // 발표영상 버튼 클릭 시
    presentationVideoButton.addEventListener('click', () => {
      presentationVideos.style.display = 'block';
      interviewVideos.style.display = 'none';
      presentationVideoButton.classList.add('active-button');
      interviewVideoButton.classList.remove('active-button');
    });

    // 면접영상 버튼 클릭 시
    interviewVideoButton.addEventListener('click', () => {
      presentationVideos.style.display = 'none';
      interviewVideos.style.display = 'block';
      interviewVideoButton.classList.add('active-button');
      presentationVideoButton.classList.remove('active-button');
    });

    function openAnalysisModal() {
      analysisModal.style.display = 'block';
      resetToSummary();
      analysisModal.querySelector('.modal-content').focus();
    }

    detailAnalysis.addEventListener('click', function(event) {
      event.preventDefault();
      summaryContent.style.display = 'none';
      detailContent.style.display = 'block';
      menuBar2.classList.remove('hidden');
      summaryResult.classList.remove('active');
      detailAnalysis.classList.add('active');
    });

    summaryResult.addEventListener('click', function(event) {
      event.preventDefault();
      resetToSummary();
    });

    function resetToSummary() {
      summaryContent.style.display = 'block';
      detailContent.style.display = 'none';
      menuBar2.classList.add('hidden');
      detailAnalysis.classList.remove('active');
      summaryResult.classList.add('active');
    }

    motionButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(motionButton, motionContent);
    });

    voiceButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(voiceButton, voiceContent);
    });

    gazeButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(gazeButton, gazeContent);
      renderGazeChart();
    });

    function activateTab(button, content) {
      motionButton.classList.remove('active');
      voiceButton.classList.remove('active');
      gazeButton.classList.remove('active');

      motionContent.classList.remove('active');
      voiceContent.classList.remove('active');
      gazeContent.classList.remove('active');

      button.classList.add('active');
      content.classList.add('active');
    }

    function renderGazeChart() {
      if (gazeChartInstance) {
        gazeChartInstance.destroy();
      }
      gazeChartInstance = new Chart(gazeChartElement, {
        type: 'line',
        data: {
          labels: ['1초', '2초', '3초', '4초', '5초'],
          datasets: [{
            label: '시선처리 데이터',
            data: [2, 1, 3, 4, 2],
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: '시간'
              }
            },
            y: {
              title: {
                display: true,
                text: '값'
              }
            }
          }
        }
      });
    }

    analysisModalClose.addEventListener('click', () => {
      closeAnalysisModal();
    });

    analysisModal.addEventListener('click', (event) => {
      if (event.target === analysisModal) {
        closeAnalysisModal();
      }
    });

    function closeAnalysisModal() {
      analysisModal.style.display = 'none';
      resetToSummary();
      analysisVideo.pause();
      analysisVideo.src = '';
    }

    /***** 평가 기록 영역 (백엔드) *****/
    function openScoreModal(element) {
      const scoreId = element.getAttribute('data-scoreid');
      fetch(`/scores/details?scoreId=${scoreId}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('modalTotalScore').textContent = data.totalScore;
          document.getElementById('modalMotionScore').textContent = data.motionScore;
          document.getElementById('modalExpressionScore').textContent = data.expressionScore;
          document.getElementById('modalLanguageScore').textContent = data.languageScore;
          document.getElementById('modalTempo').textContent = data.tempo;
          document.getElementById('modalDate').textContent = data.date;
          document.getElementById('modalVideo').src = `/myresults/upload/results/${data.fileName}`;

          displayTimes('motionTimesList', data.motionTimes);
          displayTimes('expressionTimesList', data.expressionTimes);
          displayTimes('languageTimesList', data.languageTimes);

          document.getElementById('commonModal').classList.add('active');
        })
        .catch(error => {
          console.error('데이터 로드 실패:', error);
          alert('평가 데이터를 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.');
        });
    }

    function displayTimes(elementId, timesArray) {
      const listElement = document.getElementById(elementId);
      listElement.innerHTML = '';
      timesArray.forEach(time => {
        const li = document.createElement('li');
        li.textContent = `${time.actionName || time.expressionName || time.languageName}: ${time.actionTime || time.expressionTime || time.languageTime}초`;
        listElement.appendChild(li);
      });
    }

    const scoreModalClose = document.getElementById('scoreModalClose');
    scoreModalClose.addEventListener('click', closeScoreModal);

    const commonModal = document.getElementById('commonModal');
    commonModal.addEventListener('click', (event) => {
      if (event.target === commonModal) {
        closeScoreModal();
      }
    });

    function closeScoreModal() {
      commonModal.classList.remove('active');
      document.getElementById('modalVideo').src = '';
    }
</script>
</body>
</html>

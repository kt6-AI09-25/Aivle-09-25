<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>분석 결과 및 평가 기록</title>
    <link rel="stylesheet" href="/css/myresult.css">
    <style>
        .no-videos-message {
            text-align: center;
            color: #666666;
            margin: 20px 0;
            font-size: 1.2em;
        }
        /*------------------------------- 이유찬 수정 ------------------------------ */
        /* "현재 평가 중" 섹션을 숨기거나 표시할 때 사용할 클래스 */
        .hidden {
            display: none !important;
        }

        /* 간단한 로딩 모달 예시 */
        #loadingModal {
            display: none;
            position: fixed;
            z-index: 999;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            color: #fff;
            text-align: center;
            padding-top: 200px;
            font-size: 24px;
        }
        #loadingModal.active {
            display: block !important;
        }

        /* 완료된 동영상을 표시할 컨테이너 예시 */
        #completedVideoContainer {
            margin: 20px;
            border: 2px dashed #aaa;
            padding: 10px;
        }
        #completedVideoContainer.hidden {
            display: none;
        }
        /*------------------------------- 이유찬 수정 ------------------------------*/
    </style>
</head>
<body>

<!-- 네비게이션 (Thymeleaf include) -->
<div th:replace="navbar.html"></div>

<!----------------이유찬 로딩 모달 (평가중 표시)  수정 요망 ---------------->
<div id="loadingModal" class="hidden">
    <p>분석 중입니다... 잠시만 기다려주세요.</p>
</div>

<!--  완료된 동영상을 표시할 컨테이너 -->
<div id="completedVideoContainer" class="hidden">
    <h2>평가가 완료된 영상</h2>
    <video id="completedVideo" width="400" height="240" controls></video>
</div>
<!------------------------------- 이유찬 수정 ------------------------------>

<!-- 분석 결과 영역 (프론트엔드 담당 코드) -->
<main>
    <section class="content">
        <div class="centered-content analysis-section">
            <h1 class="analysis-result">분석결과</h1>
            <div class="analysis-line"></div>
            <!-- 발표영상, 면접영상 선택 버튼 -->
            <div class="button-container">
                <button class="mui-button active-button" id="presentationVideoButton">발표영상</button>
                <button class="mui-button" id="interviewVideoButton">면접영상</button>
            </div>
        </div>

        <!-- 썸네일 컨테이너 -->
        <div class="thumbnail-container">
            <!-- 발표영상 섹션 -->
            <div id="presentationVideos">
                <div th:if="${presentationVideos != null and !#lists.isEmpty(presentationVideos)}">
                    <div th:each="video, iterStat : ${presentationVideos}">
                        <img th:if="${video.thumbnailUrl != null}"
                             th:src="@{${video.thumbnailUrl}}"
                             alt="발표영상 썸네일"
                             th:attr="data-videoUrl=${video.videoUrl}"
                             class="video-thumbnail" />
                        <div th:if="${iterStat.index % 3 == 2}" style="clear: both;"></div>
                    </div>
                </div>
                <div th:if="${presentationVideos == null or #lists.isEmpty(presentationVideos)}">
                    <h1 class="no-videos-message">저장된 발표영상이 없습니다.</h1>
                    <div style="text-align: center; margin: 20px 0;">
                        <button type="button" class="mui-button" onclick="openAnalysisModal()">결과모달 열기 (임시)</button>
                    </div>
                </div>
            </div>
            <!-- 면접영상 섹션 -->
            <div id="interviewVideos" style="display: none;">
                <div th:if="${interviewVideos != null and !#lists.isEmpty(interviewVideos)}">
                    <div th:each="video, iterStat : ${interviewVideos}">
                        <img th:if="${video.thumbnailUrl != null}"
                             th:src="@{${video.thumbnailUrl}}"
                             alt="면접영상 썸네일"
                             th:attr="data-videoUrl=${video.videoUrl}"
                             class="video-thumbnail" />
                        <div th:if="${iterStat.index % 3 == 2}" style="clear: both;"></div>
                    </div>
                </div>
                <div th:if="${interviewVideos == null or #lists.isEmpty(interviewVideos)}">
                    <h1 class="no-videos-message">저장된 면접영상이 없습니다.</h1>
                    <div style="text-align: center; margin: 20px 0;">
                        <button type="button" class="mui-button" onclick="openAnalysisModal()">결과모달 열기 (임시)</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="spacer"></div>
        <!-- 분석 결과 모달 -->
        <div id="videoModal" class="modal" role="dialog" aria-modal="true">
            <div class="modala" tabindex="-1">
                <button class="modal-close" id="analysisModalClose" aria-label="Close analysis modal">&times;</button>
                <div class="module-titleArea">
                    <h1>분석 결과</h1>
                </div>
                <div class="menu-bar" id="menuBar1">
                    <a href="#" id="summaryResult" class="active">종합결과</a>
                    <a href="#" id="detailAnalysis">세부분석</a>
                </div>
                <!-- 종합결과 -->
                <div id="summaryContent" class="summary-content">
                    <p>이곳은 종합결과를 보여주는 영역입니다.</p>
                </div>
                <!-- 세부분석 -->
                <div id="detailContent" class="detail-content">
                    <div class="menu-bar hidden" id="menuBar2">
                        <a href="#" id="motion" class="active">모션점수</a>
                        <a href="#" id="voice">표정점수</a>
                        <a href="#" id="gaze">언어점수</a>
                    </div>
                    <div class="modal-body split">
                        <div class="modal-left">
                            <video controls id="analysisVideo">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div class="modal-right">
                            <div class="frame-card">
                                <div id="motionContent" class="motion-content active">
                                    <p>모션 평가 내용이 여기에 표시됩니다.</p>
                                    <div class="chart-container">
                                        <canvas id="motionChart"></canvas>
                                    </div>
                                </div>
                                <div id="voiceContent" class="voice-content">
                                    <p>표정 평가 내용이 여기에 표시됩니다.</p>
                                    <div class="chart-container">
                                        <canvas id="expressionChart"></canvas>
                                    </div>
                                </div>
                                <div id="gazeContent" class="gaze-content">
                                    <p>언어 평가 내용이 여기에 표시됩니다.</p>
                                    <div class="chart-container">
                                        <canvas id="gazeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <!-- 평가 기록 영역 (백엔드 담당 코드) -->
    <section>
        <h1>이전 평가 기록</h1>
        <div th:each="score : ${previousScores}" class="video-container">
            <div th:if="${score.status != 'IN_PROGRESS'}" class="video-container">
            <div class="video-thumbnail" th:attr="data-scoreid=${score.scoreId}" onclick="openScoreModal(this)">
                <video width="300" height="180"
                       th:src="@{/myresults/upload/results/{fileId}(fileId=${score.fileId})}"
                       controls>
                </video>
            </div>
            <p><strong>날짜:</strong> <span th:text="${#temporals.format(score.date, 'yyyy-MM-dd HH:mm')}"></span></p>
            <p><strong>작성자:</strong> <span th:text="${score.userId}"></span></p>
        </div>
        </div>
        <h1>현재 평가 중</h1>
        <!------------------------------- 이유찬 수정 ------------------------------>
        <div id="inProgressContainer"
             th:if="${evaluatingScore != null and evaluatingScore['scoreId'] != null}"
             class="video-container">
            <!-- 평가 데이터가 있는 경우에만 이 영역이 렌더링됨 -->
            <div class="video-thumbnail" th:attr="data-scoreid=${evaluatingScore['scoreId']}"
                 onclick="openScoreModal(this)">
                <video width="300" height="180"
                       th:src="@{/myresults/upload/results/{fileId}(fileId=${evaluatingScore['fileId']})}"
                       controls>
                </video>
            </div>
            <p><strong>날짜:</strong> <span th:text="${#temporals.format(evaluatingScore['date'], 'yyyy-MM-dd HH:mm')}"></span></p>
            <p><strong>작성자:</strong> <span th:text="${evaluatingScore['userId']}"></span></p>
        </div>
        <!------------------------------- 이유찬 수정 ------------------------------>
    </section>
</main>
<!-- 평가 상세 모달 (Score Modal) -->
<div id="commonModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content" tabindex="-1">
        <button class="modal-close" id="scoreModalClose" aria-label="Close score modal">&times;</button>
        <video id="modalVideo" controls></video>
        <div class="score-details">
            <h3>총 점수: <span id="modalTotalScore"></span></h3>
            <p>움직임 점수: <span id="modalMotionScore"></span></p>
            <p>표정 점수: <span id="modalExpressionScore"></span></p>
            <p>언어 점수: <span id="modalLanguageScore"></span></p>
            <p>속도: <span id="modalTempo"></span></p>
            <p>날짜: <span id="modalDate"></span></p>
            <p>작성자: <span id="modalUserId"></span></p>
            <p>머리 움직임 유형: <span id="modalMotionFrequency"></span></p>
            <p>표정 유형: <span id="modalExpressionFrequency"></span></p>
            <p>언어 유형: <span id="modalLanguageFrequency"></span></p>
            <p>스크립트: <span id="modalScript"></span></p>
            <h4>머리 움직임 시간대</h4>
            <ul id="motionTimesList"></ul>
            <h4>표정 변화 시간대</h4>
            <ul id="expressionTimesList"></ul>
            <h4>언어 사용 시간대</h4>
            <ul id="languageTimesList"></ul>
        </div>
    </div>
</div>
<div th:replace="footer.html"></div>
<!-- 외부 Chart.js 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- 스크립트 (분석 결과 및 평가 기록 영역 기능 포함) -->
<script>
    /***** 분석 결과 영역 (프론트엔드) *****/
    const analysisModal = document.getElementById('videoModal');
    const summaryContent = document.getElementById('summaryContent');
    const detailContent = document.getElementById('detailContent');
    const menuBar2 = document.getElementById('menuBar2');
    const detailAnalysis = document.getElementById('detailAnalysis');
    const summaryResult = document.getElementById('summaryResult');
    const analysisModalClose = document.getElementById('analysisModalClose');
    const motionButton = document.getElementById('motion');
    const voiceButton = document.getElementById('voice');
    const gazeButton = document.getElementById('gaze');
    const motionContent = document.getElementById('motionContent');
    const voiceContent = document.getElementById('voiceContent');
    const gazeContent = document.getElementById('gazeContent');
    const gazeChartElement = document.getElementById('gazeChart');
    const analysisVideo = document.getElementById('analysisVideo');
    const motionChartElement = document.getElementById('motionChart');
    const expressionChartElement = document.getElementById('expressionChart');
    let gazeChartInstance = null;
    let motionChartInstance = null;
    let expressionChartInstance = null;
    const presentationVideoButton = document.getElementById('presentationVideoButton');
    const interviewVideoButton = document.getElementById('interviewVideoButton');
    const presentationThumbnail = document.getElementById('presentationThumbnail');
    const interviewThumbnail = document.getElementById('interviewThumbnail');
    const presentationVideoSrc = "/video/recorded_presentation.mp4";
    const interviewVideoSrc = "/video/recorded_interview.mp4";
    presentationVideoButton.classList.add('active-button');
    presentationVideos.style.display = 'block'; // 이유찬 수정
    interviewVideos.style.display = 'none';       // 이유찬 수정
    presentationVideoButton.addEventListener('click', () => {
      presentationVideos.style.display = 'block';
      interviewVideos.style.display = 'none';
      presentationVideoButton.classList.add('active-button');
      interviewVideoButton.classList.remove('active-button');
    });
    interviewVideoButton.addEventListener('click', () => {
      presentationVideos.style.display = 'none';
      interviewVideos.style.display = 'block';
      interviewVideoButton.classList.add('active-button');
      presentationVideoButton.classList.remove('active-button');
    });
    /******************** 이유찬 수정 ********************/
    /***** (1) 폴링 & 로딩 모달 전환 로직 *****/
    function pollEvaluatingScore() {
      fetch('/scores/results/api')
        .then(res => res.json())
        .then(data => {
          // /scores/results/api -> { previousScores: [...], evaluatingScore: {...} }
          const evalScore = data.evaluatingScore;
          const loadingModal = document.getElementById('loadingModal');
          const inProgressElem = document.getElementById('inProgressContainer');
          const completedVideoContainer = document.getElementById('completedVideoContainer');
          const completedVideo = document.getElementById('completedVideo');

          if (!evalScore || !evalScore.scoreId) {
            // "IN_PROGRESS" 자체가 없으면 => 로딩창 X, 현재평가중 X, 완료동영상 X
            loadingModal.classList.remove('active');
            inProgressElem?.classList.add('hidden');
            completedVideoContainer.classList.add('hidden');
            return;
          }

          if (evalScore.status === 'IN_PROGRESS') {
            // 평가중 => 로딩창 표시, 현재평가중 영역 표시, 완료동영상 숨김
            loadingModal.classList.add('active');
            inProgressElem?.classList.remove('hidden');
            completedVideoContainer.classList.add('hidden');

          } else if (evalScore.status === 'COMPLETED') {
            // 평가 완료 => 로딩창 숨기고, IN_PROGRESS 숨기고, 완료된 영상 보여주기
            loadingModal.classList.remove('active');
            inProgressElem?.classList.add('hidden');
            completedVideoContainer.classList.remove('hidden');

            // 새 동영상 주소 세팅
            completedVideo.src = '/myresults/upload/results/' + evalScore.fileId;
          }
        })
        .catch(err => console.error('IN_PROGRESS 체크 중 오류:', err));
    }

    // 페이지 로드 후 3초마다 폴링
    document.addEventListener('DOMContentLoaded', () => {
      setInterval(pollEvaluatingScore, 3000);
    });
    /******************** 이유찬 수정 ********************/
    /***** 기존 모달/차트 로직 *****/
    function openAnalysisModal() {
      analysisModal.style.display = 'block';
      updateSummaryContent(259);
      resetToSummary();
      analysisModal.querySelector('.modal-content').focus();
    }
    function updateSummaryContent(totalScore) {
      summaryContent.innerHTML = '<h2>총 점수: ' + totalScore + '</h2>';
    }
    detailAnalysis.addEventListener('click', function(event) {
      event.preventDefault();
      summaryContent.style.display = 'none';
      detailContent.style.display = 'block';
      menuBar2.classList.remove('hidden');
      summaryResult.classList.remove('active');
      detailAnalysis.classList.add('active');
      activateTab(motionButton, motionContent);
      renderMotionChart();
    });
    summaryResult.addEventListener('click', function(event) {
      event.preventDefault();
      resetToSummary();
    });
    function resetToSummary() {
      summaryContent.style.display = 'block';
      detailContent.style.display = 'none';
      menuBar2.classList.add('hidden');
      detailAnalysis.classList.remove('active');
      summaryResult.classList.add('active');
    }
    motionButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(motionButton, motionContent);
      renderMotionChart();
    });
    voiceButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(voiceButton, voiceContent);
      renderExpressionChart();
    });
    gazeButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(gazeButton, gazeContent);
      renderGazeChart();
    });
    function activateTab(button, content) {
      motionButton.classList.remove('active');
      voiceButton.classList.remove('active');
      gazeButton.classList.remove('active');
      motionContent.classList.remove('active');
      voiceContent.classList.remove('active');
      gazeContent.classList.remove('active');
      button.classList.add('active');
      content.classList.add('active');
    }
    function renderMotionChart() {
      if (motionChartInstance) {
        motionChartInstance.destroy();
      }
      motionChartInstance = new Chart(motionChartElement, {
        type: 'line',
        data: {
          labels: ['초기', '중간', '최종'],
          datasets: [{
            label: '모션 점수 데이터',
            data: [20, 45, 67],
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: '시간' } },
            y: { title: { display: true, text: '점수' }, beginAtZero: true }
          }
        }
      });
    }
    function renderExpressionChart() {
      if (expressionChartInstance) {
        expressionChartInstance.destroy();
      }
      expressionChartInstance = new Chart(expressionChartElement, {
        type: 'line',
        data: {
          labels: ['초기', '중간', '최종'],
          datasets: [{
            label: '표정 점수 데이터',
            data: [30, 60, 100],
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: '시간' } },
            y: { title: { display: true, text: '점수' }, beginAtZero: true }
          }
        }
      });
    }
    function renderGazeChart() {
      if (gazeChartInstance) {
        gazeChartInstance.destroy();
      }
      gazeChartInstance = new Chart(gazeChartElement, {
        type: 'line',
        data: {
          labels: ['1초', '2초', '3초', '4초', '5초'],
          datasets: [{
            label: '언어 점수 데이터',
            data: [2, 1, 3, 4, 2],
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: '시간' } },
            y: { title: { display: true, text: '값' } }
          }
        }
      });
    }
    analysisModalClose.addEventListener('click', () => {
      closeAnalysisModal();
    });
    analysisModal.addEventListener('click', (event) => {
      if (event.target === analysisModal) {
        closeAnalysisModal();
      }
    });
    function closeAnalysisModal() {
      analysisModal.style.display = 'none';
      resetToSummary();
      analysisVideo.pause();
      analysisVideo.src = '';
    }

     /***** 평가 기록 영역 (백엔드) *****/
    function openScoreModal(element) {
      const scoreId = element.getAttribute('data-scoreid');
      fetch(`/scores/details?scoreId=${scoreId}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('modalTotalScore').textContent = data.totalScore;
          document.getElementById('modalMotionScore').textContent = data.motionScore;
          document.getElementById('modalExpressionScore').textContent = data.expressionScore;
          document.getElementById('modalLanguageScore').textContent = data.languageScore;
          document.getElementById('modalTempo').textContent = data.tempo;
          document.getElementById('modalDate').textContent = data.date;
          document.getElementById('modalUserId').textContent = data.userId;
          // 이유찬 수정
          document.getElementById('modalVideo').src = `/myresults/upload/results/${data.fileId}`;

          displayTimes('motionTimesList', data.motionTimes);
          displayTimes('expressionTimesList', data.expressionTimes);
          displayTimes('languageTimesList', data.languageTimes);

          document.getElementById('commonModal').classList.add('active');
        })
        .catch(error => {
          console.error('데이터 로드 실패:', error);
          alert('평가 데이터를 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.');
        });
    }
    // 이유찬 수정
    function displayTimes(elementId, timesMap) {
      const listElement = document.getElementById(elementId);
      listElement.innerHTML = '';
      Object.entries(timesMap).forEach(([actionName, timeList]) => {
        if (timeList.length > 0) {
          timeList.forEach(time => {
            const li = document.createElement('li');
            li.textContent = `${actionName}: ${time}초`;
            listElement.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = `${actionName}: 없음`;
          listElement.appendChild(li);
        }
      });
    }
    const scoreModalClose = document.getElementById('scoreModalClose');
    scoreModalClose.addEventListener('click', closeScoreModal);
    const commonModal = document.getElementById('commonModal');
    commonModal.addEventListener('click', (event) => {
      if (event.target === commonModal) {
        closeScoreModal();
      }
    });
    function closeScoreModal() {
      commonModal.classList.remove('active');
      document.getElementById('modalVideo').src = '';
    }
</script>
</body>
</html>

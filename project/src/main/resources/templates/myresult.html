<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>분석 결과 및 평가 기록</title>
    <link rel="stylesheet" href="/css/myresult.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* “저장된 발표영상이 없습니다” 메시지 스타일 */
        .no-videos-message {
          text-align: center;
          color: #666666;
          margin: 20px 0;
          font-size: 1.2em;
        }
        /* 썸네일 컨테이너 – Flex 레이아웃으로 썸네일 개수와 상관없이 균일하게 보이도록 함 */
        .thumbnail-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
          position: relative; /* 내부에 오버레이(로딩, 완료 영상)를 배치하기 위함 */
        }
        /* 개별 썸네일 스타일 */
        .video-thumbnail {
          max-width: 300px;
          cursor: pointer;
        }
        /* 로딩 오버레이 – “분석 중입니다...” 메시지 (썸네일 내부에 오버레이) */
        #loadingModal {
          display: none;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          color: #fff;
          text-align: center;
          padding-top: 50px;
          font-size: 24px;
          z-index: 10;
        }
        #loadingModal.active {
          display: block;
        }
        /* 평가 완료 영상 오버레이 */
        #completedVideoContainer {
          display: none;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          background-color: rgba(0,0,0,0.5);
          color: #fff;
          text-align: center;
          padding: 20px;
          z-index: 10;
        }
        #completedVideoContainer.active {
          display: block;
        }
    </style>
</head>
<body>
<!-- 네비게이션 (Thymeleaf include) -->
<div th:replace="navbar.html"></div>

<main>
    <section class="content">
        <div class="centered-content analysis-section">
            <h1 class="analysis-result">분석결과</h1>
            <div class="analysis-line"></div>
            <!-- 발표영상, 면접영상 선택 버튼 -->
            <div class="button-container">
                <button class="mui-button active-button" id="presentationVideoButton">발표영상</button>
                <button class="mui-button" id="interviewVideoButton">면접영상</button>
            </div>
        </div>

        <!-- 썸네일 컨테이너 (내부에 로딩/완료 오버레이 포함) -->
        <div class="thumbnail-container">
            <!-- 로딩 오버레이 (분석중 메시지) -->

            <!-- 평가 완료 영상 오버레이 -->
            <div id="completedVideoContainer">
                <h2>평가가 완료된 영상</h2>
                <video id="completedVideo" width="400" height="240" controls></video>
                <div id="loadingModal">
                    <p>분석 중입니다... 잠시만 기다려주세요.</p>
                </div>
            </div>

            <!-- 발표영상 섹션 -->
            <div id="presentationVideos">
                <div th:if="${presentationVideos != null and !#lists.isEmpty(presentationVideos)}">
                    <div th:each="video, iterStat : ${presentationVideos}">
                        <img th:if="${video.thumbnailUrl != null}"
                             th:src="@{${video.thumbnailUrl}}"
                             alt="발표영상 썸네일"
                             th:attr="data-videoUrl=${video.videoUrl}"
                             class="video-thumbnail" />
                    </div>
                </div>
                <div th:if="${presentationVideos == null or #lists.isEmpty(presentationVideos)}">
                    <h1 class="no-videos-message">저장된 발표영상이 없습니다.</h1>
                    <div class="video-flex" style="text-align: center; margin: 20px 0;">
                        <div th:each="score : ${previousScores}" class="video-container">
                            <div th:if="${score.status != 'IN_PROGRESS'}" class="video-container">
                                <div class="video-thumbnail"
                                     th:attr="totalscore=${score.totalScore}, motionscore=${score.motionScore}, expressionscore=${score.expressionScore}, languagescore=${score.languageScore}, fileId=${score.fileId}"
                                     onclick="openScoreModal(this)">
                                    <video width="300" height="180"
                                           th:src="@{/myresults/upload/results/{fileId}(fileId=${score.fileId})}">
                                    </video>
                                </div>
                                <p><strong>날짜:</strong> <span th:text="${#temporals.format(score.date, 'yyyy-MM-dd HH:mm')}"></span></p>
                                <p><strong>작성자:</strong> <span th:text="${score.userId}"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 면접영상 섹션 -->
            <div id="interviewVideos" style="display: none;">
                <div th:if="${interviewVideos != null and !#lists.isEmpty(interviewVideos)}">
                    <div th:each="video, iterStat : ${interviewVideos}">
                        <img th:if="${video.thumbnailUrl != null}"
                             th:src="@{${video.thumbnailUrl}}"
                             alt="면접영상 썸네일"
                             th:attr="data-videoUrl=${video.videoUrl}"
                             class="video-thumbnail" />
                        <div th:if="${iterStat.index % 3 == 2}" style="clear: both;"></div>
                    </div>
                </div>
                <div th:if="${interviewVideos == null or #lists.isEmpty(interviewVideos)}">
                    <h1 class="no-videos-message">저장된 면접영상이 없습니다.</h1>
                    <div style="text-align: center; margin: 20px 0;">
                        <div th:each="score : ${previousScores}" class="video-container">
                            <div th:if="${score.status != 'IN_PROGRESS'}" class="video-container">
                                <div class="video-thumbnail"
                                     th:attr="totalscore=${score.totalScore}, motionscore=${score.motionScore}, fileId=${score.fileId}"
                                     onclick="openScoreModal(this)">
                                    <video width="350" height="230"
                                           th:src="@{/myresults/upload/results/{fileId}(fileId=${score.fileId})}">
                                    </video>
                                </div>
                                <p><strong>날짜:</strong> <span th:text="${#temporals.format(score.date, 'yyyy-MM-dd HH:mm')}"></span></p>
                                <p><strong>작성자:</strong> <span th:text="${score.userId}"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="spacer"></div>

        <!-- 분석 결과 모달 -->
        <div id="videoModal" class="modal" role="dialog" aria-modal="true">
            <div class="modala" tabindex="-1">
                <button class="modal-close" id="analysisModalClose" aria-label="Close analysis modal">&times;</button>
                <div class="module-titleArea">
                    <h1>분석 결과</h1>
                </div>
                <div class="menu-bar" id="menuBar1">
                    <a href="#" id="summaryResult" class="active">종합결과</a>
                    <a href="#" id="detailAnalysis">세부분석</a>
                </div>
                <!-- 종합결과 -->
                <div id="summaryContent" class="summary-content">
                    <!-- 점수 관련 내용 영역 -->
                    <div id="scoreSummary"></div>
                    <!-- 진행률 영역: 하드코딩된 기본값 대신 빈 상태로 두고 함수에서 업데이트 -->
                    <div class="progress-container">
                        <p class="rank-text"><strong id="rank-label"></strong> <span id="percent-value"></span>%</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                            <div class="progress-marker"></div>
                        </div>
                        <p class="progress-description">전체 면접 영상 중 내 면접 영상의 순위</p>
                    </div>
                </div>
                <!-- 세부분석 -->
                <div id="detailContent" class="detail-content">
                    <div class="menu-bar hidden" id="menuBar2">
                        <a href="#" id="motion" class="active">모션점수</a>
                        <a href="#" id="voice">표정점수</a>
                        <a href="#" id="gaze">언어점수</a>
                    </div>
                    <div class="modal-body split">
                        <div class="modal-left">
                            <video controls id="analysisVideo">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div class="modal-right">
                            <div class="frame-card">
                                <div id="motionContent" class="motion-content active">
                                    <p id="motionScoreText">모션 평가 내용이 여기에 표시됩니다.</p>
                                    <div class="chart-container">
                                        <canvas id="motionChart"></canvas>
                                    </div>
                                </div>
                                <div id="voiceContent" class="voice-content">
                                    <p>표정 평가 내용이 여기에 표시됩니다.</p>
                                    <div class="chart-container">
                                        <canvas id="expressionChart"></canvas>
                                    </div>
                                </div>
                                <div id="gazeContent" class="gaze-content">
                                    <p>언어 평가 내용이 여기에 표시됩니다.</p>
                                    <div class="chart-container">
                                        <canvas id="gazeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <!-- 평가 기록 영역 (백엔드 담당 코드) -->
    <!-- 기존 평가 기록 영역은 주석 처리되어 있음 -->
</main>

<!-- 평가 상세 모달 (Score Modal) -->
<div id="commonModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content" tabindex="-1">
        <button class="modal-close" id="scoreModalClose" aria-label="Close score modal">&times;</button>
        <video id="modalVideo" controls></video>
        <div class="score-details">
            <h3>총 점수: <span id="modalTotalScore"></span></h3>
            <p>움직임 점수: <span id="modalMotionScore"></span></p>
            <p>표정 점수: <span id="modalExpressionScore"></span></p>
            <p>언어 점수: <span id="modalLanguageScore"></span></p>
            <p>속도: <span id="modalTempo"></span></p>
            <p>날짜: <span id="modalDate"></span></p>
            <p>작성자: <span id="modalUserId"></span></p>
            <p>머리 움직임 유형: <span id="modalMotionFrequency"></span></p>
            <p>표정 유형: <span id="modalExpressionFrequency"></span></p>
            <p>언어 유형: <span id="modalLanguageFrequency"></span></p>
            <p>스크립트: <span id="modalScript"></span></p>
            <h4>머리 움직임 시간대</h4>
            <ul id="motionTimesList"></ul>
            <h4>표정 변화 시간대</h4>
            <ul id="expressionTimesList"></ul>
            <h4>언어 사용 시간대</h4>
            <ul id="languageTimesList"></ul>
        </div>
    </div>
</div>

<div th:replace="footer.html"></div>

<!-- 외부 Chart.js 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- 스크립트 (분석 결과 및 평가 기록 영역 기능 포함) -->
<script>
    /***** 분석 결과 영역 (프론트엔드) *****/
    const analysisModal = document.getElementById('videoModal');
    const summaryContent = document.getElementById('summaryContent');
    const detailContent = document.getElementById('detailContent');
    const menuBar2 = document.getElementById('menuBar2');
    const detailAnalysis = document.getElementById('detailAnalysis');
    const summaryResult = document.getElementById('summaryResult');
    const analysisModalClose = document.getElementById('analysisModalClose');
    const motionButton = document.getElementById('motion');
    const voiceButton = document.getElementById('voice');
    const gazeButton = document.getElementById('gaze');
    const motionContent = document.getElementById('motionContent');
    const voiceContent = document.getElementById('voiceContent');
    const gazeContent = document.getElementById('gazeContent');
    const gazeChartElement = document.getElementById('gazeChart');
    const analysisVideo = document.getElementById('analysisVideo');
    const motionChartElement = document.getElementById('motionChart');
    const expressionChartElement = document.getElementById('expressionChart');
    let gazeChartInstance = null;
    let motionChartInstance = null;
    let expressionChartInstance = null;
    const presentationVideoButton = document.getElementById('presentationVideoButton');
    const interviewVideoButton = document.getElementById('interviewVideoButton');
    presentationVideoButton.classList.add('active-button');
    presentationVideos.style.display = 'block';
    interviewVideos.style.display = 'none';
    presentationVideoButton.addEventListener('click', () => {
      presentationVideos.style.display = 'block';
      interviewVideos.style.display = 'none';
      presentationVideoButton.classList.add('active-button');
      interviewVideoButton.classList.remove('active-button');
    });
    interviewVideoButton.addEventListener('click', () => {
      presentationVideos.style.display = 'none';
      interviewVideos.style.display = 'block';
      interviewVideoButton.classList.add('active-button');
      presentationVideoButton.classList.remove('active-button');
    });

    /***** 폴링 및 로딩/완료 오버레이 업데이트 *****/
    function pollEvaluatingScore() {
      fetch('/scores/results/api')
        .then(res => res.json())
        .then(data => {
          const evalScore = data.evaluatingScore;
          const loadingModal = document.getElementById('loadingModal');
          const completedVideoContainer = document.getElementById('completedVideoContainer');
          const completedVideo = document.getElementById('completedVideo');

          if (!evalScore || !evalScore.scoreId) {
            loadingModal.classList.remove('active');
            completedVideoContainer.classList.remove('active');
            return;
          }

          if (evalScore.status === 'IN_PROGRESS') {
            loadingModal.classList.add('active');
            completedVideoContainer.classList.remove('active');
          } else if (evalScore.status === 'COMPLETED') {
            loadingModal.classList.remove('active');
            completedVideoContainer.classList.add('active');
            completedVideo.src = '/myresults/upload/results/' + evalScore.fileId;
          }
        })
        .catch(err => console.error('Error in polling:', err));
    }
    document.addEventListener('DOMContentLoaded', () => {
      setInterval(pollEvaluatingScore, 3000);
    });

    /***** 기존 모달/차트 로직 *****/
    function openAnalysisModal() {
      analysisModal.style.display = 'block';
      resetToSummary();
      analysisModal.querySelector('.modal-content').focus();
    }
    // updateSummaryContent() 함수: 점수 정보를 출력한 후 updateProgress()를 호출하여 진행률을 업데이트합니다.
    function updateSummaryContent(totalScore, motionScore, expressionScore, languageScore, percentile) {
        let summaryText =
            '<h2>총 점수: ' + totalScore + '</h2>' +
            '<h2>모션 점수: ' + motionScore + '</h2>' +
            '<h2>표정 점수: ' + expressionScore + '</h2>' +
            '<h2>언어 점수: ' + languageScore + '</h2>';
        if (percentile >= 50) {
            summaryText += `<p>상위 ${100 - percentile}% 입니다.</p>`;
        } else {
            summaryText += `<p>하위 ${percentile}% 입니다.</p>`;
        }
        document.getElementById("scoreSummary").innerHTML = summaryText;
        updateProgress(percentile);
    }
    detailAnalysis.addEventListener('click', function(event) {
      event.preventDefault();
      summaryContent.style.display = 'none';
      detailContent.style.display = 'block';
      menuBar2.classList.remove('hidden');
      summaryResult.classList.remove('active');
      detailAnalysis.classList.add('active');
      activateTab(motionButton, motionContent);
      renderMotionChart();
    });
    summaryResult.addEventListener('click', function(event) {
      event.preventDefault();
      resetToSummary();
    });
    function resetToSummary() {
      summaryContent.style.display = 'block';
      detailContent.style.display = 'none';
      menuBar2.classList.add('hidden');
      detailAnalysis.classList.remove('active');
      summaryResult.classList.add('active');
    }
    motionButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(motionButton, motionContent);
      renderMotionChart();
    });
    voiceButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(voiceButton, voiceContent);
      renderExpressionChart();
    });
    gazeButton.addEventListener('click', function(event) {
      event.preventDefault();
      activateTab(gazeButton, gazeContent);
      renderGazeChart();
    });
    function activateTab(button, content) {
      motionButton.classList.remove('active');
      voiceButton.classList.remove('active');
      gazeButton.classList.remove('active');
      motionContent.classList.remove('active');
      voiceContent.classList.remove('active');
      gazeContent.classList.remove('active');
      button.classList.add('active');
      content.classList.add('active');
    }
    function renderMotionChart() {
      if (motionChartInstance) {
        motionChartInstance.destroy();
      }
      motionChartInstance = new Chart(motionChartElement, {
        type: 'line',
        data: {
          labels: ['초기', '중간', '최종'],
          datasets: [{
            label: '모션 점수 데이터',
            data: [20, 45, 67],
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: '시간' } },
            y: { title: { display: true, text: '점수' }, beginAtZero: true }
          }
        }
      });
    }
    function renderExpressionChart() {
      if (expressionChartInstance) {
        expressionChartInstance.destroy();
      }
      expressionChartInstance = new Chart(expressionChartElement, {
        type: 'line',
        data: {
          labels: ['초기', '중간', '최종'],
          datasets: [{
            label: '표정 점수 데이터',
            data: [30, 60, 100],
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: '시간' } },
            y: { title: { display: true, text: '점수' }, beginAtZero: true }
          }
        }
      });
    }
    function renderGazeChart() {
      if (gazeChartInstance) {
        gazeChartInstance.destroy();
      }
      gazeChartInstance = new Chart(gazeChartElement, {
        type: 'line',
        data: {
          labels: ['1초', '2초', '3초', '4초', '5초'],
          datasets: [{
            label: '언어 점수 데이터',
            data: [2, 1, 3, 4, 2],
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: '시간' } },
            y: { title: { display: true, text: '값' } }
          }
        }
      });
    }
    analysisModalClose.addEventListener('click', () => {
      closeAnalysisModal();
    });
    analysisModal.addEventListener('click', (event) => {
      if (event.target === analysisModal) {
        closeAnalysisModal();
      }
    });
    function closeAnalysisModal() {
      analysisModal.style.display = 'none';
      resetToSummary();
      analysisVideo.pause();
      analysisVideo.src = '';
    }

    /***** 평가 기록 영역 (백엔드) *****/
    function openScoreModal(element) {
      const totalscore = element.getAttribute('totalscore');
      const motionscore = element.getAttribute('motionscore');
      const expressionscore = element.getAttribute('expressionscore');
      const languagescore = element.getAttribute('languagescore');
      const fileId = element.getAttribute('fileId');

      const videoElement = document.getElementById('analysisVideo');
      if (videoElement) {
        videoElement.src = `/myresults/upload/results/${fileId}`;
        videoElement.load();
      }
      fetch(`/scores/distribution?totalscore=${totalscore}`)
        .then(response => response.json())
        .then(percentile => {
            updateSummaryContent(totalscore, motionscore, expressionscore, languagescore, percentile);
        })
        .catch(error => {
            console.error('데이터 로드 실패:', error);
            alert('평가 데이터를 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.');
        });

      analysisModal.style.display = 'block';
      resetToSummary();
      analysisModal.querySelector('.modal-content').focus();
    }
    function updateMotionScore(motionScore) {
      const motionScoreText = document.getElementById('motionScoreText');
      if (motionScoreText) {
        motionScoreText.innerText = `모션점수 = ${motionScore}`;
      }
    }
    function displayTimes(elementId, timesMap) {
      const listElement = document.getElementById(elementId);
      listElement.innerHTML = '';
      Object.entries(timesMap).forEach(([actionName, timeList]) => {
        if (timeList.length > 0) {
          timeList.forEach(time => {
            const li = document.createElement('li');
            li.textContent = `${actionName}: ${time}초`;
            listElement.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = `${actionName}: 없음`;
          listElement.appendChild(li);
        }
      });
    }
    const scoreModalClose = document.getElementById('scoreModalClose');
    scoreModalClose.addEventListener('click', closeScoreModal);
    const commonModal = document.getElementById('commonModal');
    commonModal.addEventListener('click', (event) => {
      if (event.target === commonModal) {
        closeScoreModal();
      }
    });
    function closeScoreModal() {
      commonModal.classList.remove('active');
      document.getElementById('modalVideo').src = '';
    }

    // updateProgress() 함수: 전달받은 percentile 값에 따라 진행률과 순위 텍스트를 업데이트합니다.
    function updateProgress(percentile) {
      const progressFill = document.getElementById("progress-fill");
      const progressMarker = document.querySelector(".progress-marker");
      const rankLabel = document.getElementById("rank-label");
      const percentValue = document.getElementById("percent-value");

      // 퍼센트 값을 설정
      percentValue.textContent = percentile;

      // 막대의 위치 업데이트 (왼쪽->오른쪽 진행)
      let position = percentile + "%";
      progressFill.style.width = position;
      progressMarker.style.left = position;

      // 상위 / 하위 텍스트 변경
      if (percentile >= 50) {
          rankLabel.textContent = "상위";
      } else {
          rankLabel.textContent = "하위";
      }
    }
</script>

<!-- 추가 스크립트: 썸네일이 있으면 '저장된 발표영상이 없습니다' 메시지 숨기기 -->
<script>
    document.addEventListener("DOMContentLoaded", function(){
      const presentationSection = document.getElementById("presentationVideos");
      const thumbnails = presentationSection.querySelectorAll(".video-thumbnail");
      if(thumbnails.length > 0){
        const noVideosMsg = presentationSection.querySelector(".no-videos-message");
        if(noVideosMsg){
          noVideosMsg.style.display = "none";
        }
      }
    });
</script>

</body>
</html>

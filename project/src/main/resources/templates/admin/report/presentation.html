<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>관리자 페이지 - 회원 관리</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* 기본 스타일 */



        /* 회원 관리 섹션 컨테이너 (배경 박스) */
        .members-section {
          background-color: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          padding: 20px;
        }
        .members-section h3 {
          margin-bottom: 16px;
          font-size: 1.2rem;
          font-weight: bold;
        }

        /* 테이블 래퍼(가로 스크롤 등 필요 시) */
        .table-wrapper {
          overflow-x: auto;  /* 표가 너무 넓으면 가로 스크롤 허용 */
        }

        /* 테이블 스타일 */
        table {
          width: 100%;
          border-collapse: collapse;  /* 테두리를 겹치지 않고 합침 */
          background-color: #fff;
          min-width: 700px;           /* 너무 좁아지지 않도록 최소 너비 */
        }
        thead {
          background-color: #f8f8f8;
        }
        th, td {
          padding: 14px 16px;
          border-bottom: 1px solid #ddd;
          text-align: center;
          vertical-align: middle;
          font-size: 0.95rem;
        }
        th {
          white-space: nowrap;
          border-bottom: .1px solid #333;
        }
        tbody tr:hover {
          background-color: #f9f9f9;  /* 행에 마우스 오버 시 하이라이트 */
        }

        /* 버튼 스타일 */
        button {
          padding: 6px 12px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.85rem;
        }
        .block-btn {
          background-color: #f0ad4e; /* 주황색 */
          color: #fff;
        }
        .delete-btn {
          background-color: #d9534f; /* 빨간색 */
          color: #fff;
        }
        button:hover {
          opacity: 0.9;
        }

        /* 차단 기간 select */
        select {
          padding: 4px;
          font-size: 0.85rem;
          margin-right: 6px;
        }

        /* 반응형 조정 (화면 폭이 좁아질 경우 폰트 크기 조금 줄이기 등) */
        @media (max-width: 768px) {
          .page-title {
            font-size: 1.3rem;
          }
          th, td {
            font-size: 0.9rem;
            padding: 10px;
          }
          .members-section {
            padding: 15px;
          }
        }

        .button-group {
          display: flex;
          justify-content: center;
          margin-bottom: 10px;
      }

      .score-btn {
          padding: 10px 15px;
          margin: 5px;
          border: none;
          background-color: #007bff;
          color: white;
          border-radius: 5px;
          cursor: pointer;
      }

      .score-btn:hover {
          background-color: #0056b3;
      }

        /* 모달 기본 스타일 */
        .stat-modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.4);
      }

      /* 모달 내부 컨텐츠 */
      .stat-modal-content {
          background-color: #fff;
          margin: 5% auto;
          padding: 20px;
          width: 60%;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* 모달 내부 Grid 레이아웃 */
      .modal-grid {
          display: grid;
          grid-template-columns: 2fr 1fr; /* 왼쪽(차트) 2비율, 오른쪽(글) 1비율 */
          gap: 10px;
          align-items: center;
      }

      /* 차트 컨테이너 */
      .chart-container {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }

      /* 오른쪽 글 컨테이너 */
      .text-container {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }

      /* 글 박스 스타일 */
      .text-box {
          background-color: #f8f8f8;
          padding: 20px;
          text-align: center;
          border: 1px solid #ccc;
          border-radius: 5px;
      }

/* 닫기 버튼 */
.stat-close-btn {
    color: #aaa;
    float: right;
    font-size: 24px;
    cursor: pointer;
}

.stat-close-btn:hover {
    color: black;
}


/* 버튼 그룹 스타일 */
.button-group {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
}

.score-btn {
    padding: 10px 15px;
    margin: 5px;
    border: none;
    background-color: #007bff;
    color: white;
    border-radius: 5px;
    cursor: pointer;
}

.score-btn:hover {
    background-color: #0056b3;
}

/* 모달 내부 Grid 레이아웃 */
.modal-grid {
    display: grid;
    grid-template-columns: 2fr 1fr; /* 왼쪽(차트) 2, 오른쪽(텍스트) 1 */
    gap: 10px;
    align-items: center;
}

/* 차트 컨테이너 */
.chart-container {
    width: 100%;
}

/* 모달 내부 텍스트 스타일 */
.text-box {
    background-color: #f8f8f8;
    padding: 20px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 5px;
}


    </style>
</head>
<body>
<!-- 사이드바 -->
<div th:replace="navbar.html"></div>
<div class="sidebar">
    <h2>Admin</h2>
    <ul class="menu">
        <li><a href="/admin">메인</a></li>
        <li><a href="/admin/members">회원 관리</a></li>
        <li><a href="/admin/report">게시판 신고 관리</a></li>
        <li><a href="/admin/prView" class="active">발표 내용 조회</a></li>
        <li><a href="statistics.html">통계 페이지</a></li>
    </ul>

    <footer class="sidebar-footer">
        <!-- 홈페이지 링크 -->
        <a href="/">홈페이지로 돌아가기</a>
    </footer>
</div>

<!-- 메인 컨텐츠 -->
<div class="content">

    <h1 class="page-title">발표 내용 조회</h1>
    <div class="title-line"></div>

    <div class="dashboard-cards">
        <!-- 예시 카드 1: 전체 회원 수 -->
        <div class="card">
            <h3>행동 점수 평균</h3>
            <p>95점</p>
        </div>
        <!-- 예시 카드 2: 오늘 신규 가입 -->
        <div class="card">
            <h3>표정 점수 평균</h3>
            <p>95점</p>
        </div>
        <!-- 예시 카드 3: 미처리 신고 -->
        <div class="card">
            <h3>언어 점수 평균</h3>
            <p>95점</p>
        </div>
        <!-- 예시 카드 4: 발표 등록 수 -->
        <div class="card">
            <h3>총합 점수 평균</h3>
            <p>285점</p>
        </div>
    </div>
    <div class="members-section">

        <!-- 테이블 래퍼 -->
        <!-- 카드 형태의 주요 지표 -->

        <h3>발표 점수 목록</h3>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>회원 ID</th>
                    <th>발표 날짜</th>
                    <th>행동 점수</th>
                    <th>표정 점수</th>
                    <th>언어 점수</th>
                    <th>점수 총합</th>
                </tr>
                </thead>
                <tbody>
                <!-- 예시 회원 1 -->
                <tr>
                    <td>gildong</td>
                    <td>2024-02-04</td>
                    <td>95</td>
                    <td>95</td>
                    <td>95</td>
                    <td>285</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 발표 점수 상세 조회 모달 -->
    <div id="scoreStatModal" class="stat-modal">
        <div class="stat-modal-content">
            <span class="stat-close-btn">&times;</span>
            <h2 id="modalTitle">발표 점수 상세 정보</h2>

            <!-- 점수 선택 버튼 -->
            <div class="button-group">
                <button class="score-btn" data-type="behavior">행동 점수</button>
                <button class="score-btn" data-type="expression">표정 점수</button>
                <button class="score-btn" data-type="language">언어 점수</button>
                <button class="score-btn" data-type="total">총합 점수</button>
            </div>

            <!-- 그리드 레이아웃 -->
            <div class="modal-grid">
                <!-- 차트 영역 -->
                <div class="chart-container">
                    <canvas id="scoreChart"></canvas>
                </div>

                <!-- 점수 상세 정보 -->
                <div class="text-container">
                    <div class="text-box">
                        <p><strong>회원 ID:</strong> <span id="modalUserId"></span></p>
                        <p><strong>발표 날짜:</strong> <span id="modalDate"></span></p>
                        <p><strong>현재 점수:</strong> <span id="modalScore"></span>점</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
          let chartInstance = null;
          let currentUserId = "";
          let currentDate = "";

          // 모달 열기 (테이블 행 클릭)
          $(document).on("click", ".table-wrapper tbody tr", function () {
              currentUserId = $(this).find("td:eq(0)").text().trim();
              currentDate = $(this).find("td:eq(1)").text().trim();
              let behaviorScore = parseFloat($(this).find("td:eq(2)").text().trim());
              let expressionScore = parseFloat($(this).find("td:eq(3)").text().trim());
              let languageScore = parseFloat($(this).find("td:eq(4)").text().trim());
              let totalScore = parseFloat($(this).find("td:eq(5)").text().trim());

              // 모달에 기본 데이터 설정
              $("#modalUserId").text(currentUserId);
              $("#modalDate").text(currentDate);

              // 모달 초기값: "총합 점수" 표시
              updateModalContent("total", totalScore, [behaviorScore, expressionScore, languageScore, totalScore]);

              // 모달 표시
              $("#scoreStatModal").fadeIn();
          });

          // 버튼 클릭 시 모달 내용 변경
          $(document).on("click", ".score-btn", function () {
              let scoreType = $(this).data("type");
              let scoreValue;

              // 현재 클릭된 행에서 점수 가져오기
              let behaviorScore = parseFloat($(".table-wrapper tbody tr.selected td:eq(2)").text().trim());
              let expressionScore = parseFloat($(".table-wrapper tbody tr.selected td:eq(3)").text().trim());
              let languageScore = parseFloat($(".table-wrapper tbody tr.selected td:eq(4)").text().trim());
              let totalScore = parseFloat($(".table-wrapper tbody tr.selected td:eq(5)").text().trim());

              let scoreArray = [behaviorScore, expressionScore, languageScore, totalScore];

              switch (scoreType) {
                  case "behavior":
                      scoreValue = behaviorScore;
                      break;
                  case "expression":
                      scoreValue = expressionScore;
                      break;
                  case "language":
                      scoreValue = languageScore;
                      break;
                  case "total":
                      scoreValue = totalScore;
                      break;
                  default:
                      scoreValue = 0;
              }

              updateModalContent(scoreType, scoreValue, scoreArray);
          });

          // 모달 닫기
          $(document).on("click", ".stat-close-btn", function () {
              $("#scoreStatModal").fadeOut();
          });

          $(document).on("click", function (event) {
              if ($(event.target).attr("id") === "scoreStatModal") {
                  $("#scoreStatModal").fadeOut();
              }
          });

          // 점수 변경 시 모달 업데이트
          function updateModalContent(scoreType, scoreValue, scoreArray) {
              let titleMap = {
                  behavior: "행동 점수 상세 조회",
                  expression: "표정 점수 상세 조회",
                  language: "언어 점수 상세 조회",
                  total: "총합 점수 상세 조회"
              };

              // 제목 변경
              $("#modalTitle").text(titleMap[scoreType]);

              // 점수 업데이트
              $("#modalScore").text(scoreValue);

              // 차트 업데이트
              updateChart(scoreArray);
          }

          // 차트 업데이트 함수
          function updateChart(scoreArray) {
              if (chartInstance) {
                  chartInstance.destroy();
              }

              let ctx = document.getElementById("scoreChart").getContext("2d");
              chartInstance = new Chart(ctx, {
                  type: "bar",
                  data: {
                      labels: ["행동 점수", "표정 점수", "언어 점수", "총합 점수"],
                      datasets: [{
                          label: "점수",
                          data: scoreArray,
                          backgroundColor: ["blue", "green", "orange", "red"]
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {
                          y: { beginAtZero: true }
                      }
                  }
              });
          }
      });

    </script>

    <script>
        $(document).ready(function () {
            function loadScores() {
                $.ajax({
                    url: "/scores/all",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        let tbody = $(".table-wrapper tbody");
                        tbody.empty(); // 기존 데이터 초기화

                        if (data.length === 0) {
                            tbody.append("<tr><td colspan='6'>데이터가 없습니다.</td></tr>");
                            return;
                        }

                        data.forEach(function (score) {
                            let row = `
                                <tr>
                                    <td>${score.userId}</td>
                                    <td>${formatDate(score.date)}</td>
                                    <td>${score.motionScore}</td>
                                    <td>${score.expressionScore}</td>
                                    <td>${score.languageScore}</td>
                                    <td>${score.totalScore}</td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                    },
                    error: function () {
                        alert("점수 데이터를 불러오는 데 실패했습니다.");
                    }
                });
            }

            // 페이지 로드 시 데이터 로드
            loadScores();
        });

        function formatDate(isoString) {
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
    </script>
</div><!-- /.content -->
</body>
</html>

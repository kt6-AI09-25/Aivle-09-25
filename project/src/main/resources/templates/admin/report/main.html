<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>관리자 페이지 - 메인</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* 대시보드용 간단한 카드 스타일 */

        .online-users {
          background-color: #fff;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .online-users h3 {
          margin-bottom: 15px;
          font-size: 1.2rem;
          color: #333;
        }

        /* 최근 활동 섹션 예시 */
        .recent-activities {
          background-color: #fff;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .recent-activities h3 {
          margin-bottom: 15px;
          font-size: 1.2rem;
          color: #333;
        }
        .activities-list {
          list-style: none;
          margin: 0;
          padding: 0;
        }
        .activities-list li {
          padding: 10px 0;
          border-bottom: 1px solid #eee;
        }
        .activities-list li:last-child {
          border-bottom: none;
        }
        .activity-title {
          font-weight: bold;
          margin-right: 5px;
        }
        .activity-time {
          color: #999;
          font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div th:replace="navbar.html"></div>
<div class="admin-container">
    <!-- 사이드바 -->
    <div class="sidebar">
        <h2>Admin</h2>
        <ul class="menu">
            <li><a href="/admin" class="active">메인</a></li>
            <li><a href="/admin/members">회원 관리</a></li>
            <li><a href="/admin/report">게시판 신고 관리</a></li>
            <li><a href="/admin/prView">발표 내용 조회</a></li>
            <li><a href="statistics.html">통계 페이지</a></li>
        </ul>

        <footer class="sidebar-footer">
            <!-- 홈페이지 링크 -->
            <a href="/">홈페이지로 돌아가기</a>
        </footer>
    </div>

    <!-- 메인 컨텐츠 영역 -->
    <div class="content">
        <h1 class="page-title">관리자 메인 페이지</h1>
        <div class="title-line"></div>

        <!-- 카드 형태의 주요 지표 -->
        <div class="dashboard-cards">
            <!-- <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<2025-02-03 10:40 박청하<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< -->
            <div class="card">
                <h3>전체 회원 수</h3>
                <p id="total-users">로딩 중...</p>
            </div>
            <div class="card">
                <h3>오늘 신규 가입</h3>
                <p id="today-joined">로딩 중...</p>
            </div>
            <div class="card">
                <h3>미처리 신고</h3>
                <p id="unprocessed-reports">로딩 중...</p>
            </div>
            <div class="card">
                <h3>발표 등록 수</h3>
                <p id="total-posts">로딩 중...</p>
            </div>
            <!-- >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>2025-02-03 10:40 박청하>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> -->
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <div class="dashboard-cards">

            <div class="chart-card">
                <h3>3종류 스코어 개별 평균</h3>
                <div class="chart-container">
                    <canvas id="myChartAvg"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>등수</h3>
                <ul id="rankingList" class="activities-list">
                    <li>로딩 중...</li>
                </ul>
            </div>


            <div class="chart-card">
                <h3>등수</h3>
                <ul class="activities-list">
                <li>
                    <span>길동</span>
                </li>
                <li>
                    <span>길동</span>
                </li>
                <li>
                    <span>길동</span>
                </li>
                <li>
                    <span>길동</span>
                </li>
                </ul>
            </div>
        </div>

        <div class="dashboard-cards">

            <div class="chart-card">
                <h3>최근 7일 서비스이용</h3>
                <div class="chart-container">
                    <canvas id="myChartRecent"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>접속중인 회원</h3>
                <ul id="activeUsersList" class="users-list">
                    <li>로딩 중...</li>
                </ul>
            </div>
        </div>

        <div class="recent-activities">
                    <h3>최근 활동</h3>
                    <ul id="activityList" class="activities-list">
                        <li>로딩 중...</li>
                    </ul>
        </div>
      
        <script>
            //<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<2025-02-03 10:40 박청하<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

            async function fetchUserStats() {
                try {
                    const response = await fetch('/admin/statistics');
                    if (!response.ok) {
                        throw new Error('데이터를 불러오는 데 실패했습니다.');
                    }

                    const data = await response.json();

                    // 받아온 데이터를 화면에 반영
                    document.getElementById('total-users').textContent = `${data.totalUsers}명`;
                    document.getElementById('today-joined').textContent = `${data.todayJoinedUsers}명`;
                    document.getElementById('unprocessed-reports').textContent = `${data.unprocessedReports}건`;
                    document.getElementById('total-posts').textContent = `${data.totalPosts}건`;

                } catch (error) {
                    console.error('회원 데이터 가져오기 오류:', error);
                    document.getElementById('total-users').textContent = '불러오기 실패';
                    document.getElementById('today-joined').textContent = '불러오기 실패';
                }
            }

            // 페이지 로딩 후 데이터 가져오기
            document.addEventListener('DOMContentLoaded', fetchUserStats);

            async function fetchRecentActivities() {
                try {
                    const response = await fetch('/admin/recent-activities');
                    if (!response.ok) throw new Error('데이터를 불러오는 데 실패했습니다.');

                    const activities = await response.json();
                    const activityList = document.getElementById("activityList");
                    activityList.innerHTML = ""; // 기존 목록 초기화

                    if (activities.length === 0) {
                        activityList.innerHTML = "<li>최근 활동 내역이 없습니다.</li>";
                        return;
                    }

                    activities.forEach(activity => {
                        const listItem = document.createElement("li");
                        let link = activity.targetId ? `<a href="/posts/${activity.targetId}">게시글 보기</a>` : "";
                        listItem.innerHTML = `<strong>${activity.username}</strong>님이 ${activity.action} ${link} - <span class="activity-time">${activity.formattedCreatedAt}</span>`;
                        activityList.appendChild(listItem);
                    });
                } catch (error) {
                    console.error("최근 활동 불러오기 실패:", error);
                    document.getElementById("activityList").innerHTML = "<li>활동 내역을 불러오는 중 오류가 발생했습니다.</li>";
                }
            }

            document.addEventListener("DOMContentLoaded", fetchRecentActivities);


            async function fetchRecentScoresChart() {
                try {
                    const response = await fetch('/scores/recent-counts'); // 최근 7일간 Score 개수 가져오는 API
                    if (!response.ok) throw new Error('데이터를 불러오는 데 실패했습니다.');

                    const data = await response.json();

                    const labels = data.map(item => item.date); // 날짜 리스트
                    const counts = data.map(item => item.count); // 점수 개수 리스트

                    // 차트 그리기
                    const ctx2 = document.getElementById('myChartRecent').getContext('2d');
                    new Chart(ctx2, {
                        type: 'line', // 꺾은선 그래프
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '최근 7일간 Score 등록 수',
                                data: counts,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderWidth: 2,
                                tension: 0.3, // 곡선 정도 (0 = 직선)
                                pointRadius: 5, // 포인트 크기
                                pointBackgroundColor: 'rgba(255, 99, 132, 1)' // 포인트 색상
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                } catch (error) {
                    console.error('최근 7일간 Score 데이터 불러오기 실패:', error);
                }
            }

            // 페이지 로딩 후 실행
            document.addEventListener('DOMContentLoaded', fetchRecentScoresChart);

            let myChartInstance = null;

            async function fetchAverageScoresChart() {
                try {
                    const response = await fetch('/scores/averages'); // 3종류의 평균 스코어 가져오는 API
                    if (!response.ok) throw new Error('데이터를 불러오는 데 실패했습니다.');

                    const data = await response.json();

                    const labels = ['Motion Score', 'Expression Score', 'Language Score']; // 카테고리 라벨
                    const scores = [data.motionScore, data.expressionScore, data.languageScore]; // 평균 스코어

                    // 기존 차트가 있다면 삭제 (destroy)
                    if (myChartInstance) {
                        myChartInstance.destroy();
                    }

                    // 차트 그리기
                    const ctx1 = document.getElementById('myChartAvg').getContext('2d');
                    new Chart(ctx1, {
                        type: 'bar', // 히스토그램(막대 그래프)
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '평균 스코어',
                                data: scores,
                                backgroundColor: [
                                    'rgba(54, 162, 235, 0.7)', // 파란색
                                    'rgba(255, 99, 132, 0.7)', // 빨간색
                                    'rgba(75, 192, 192, 0.7)'  // 초록색
                                ],
                                borderColor: [
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(75, 192, 192, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                } catch (error) {
                    console.error('평균 스코어 데이터 불러오기 실패:', error);
                }
            }

            // 페이지 로딩 후 실행
            document.addEventListener('DOMContentLoaded', fetchAverageScoresChart);

            async function fetchTop4Scores() {
                try {
                    const response = await fetch('/scores/top4');
                    if (!response.ok) throw new Error('데이터를 불러오는 데 실패했습니다.');

                    const data = await response.json();
                    const rankingList = document.getElementById("rankingList");
                    rankingList.innerHTML = ""; // 기존 목록 초기화

                    data.forEach((item, index) => {
                        const listItem = document.createElement("li");
                        listItem.innerHTML = `<strong>${index + 1}위:</strong> ${item.username || '알 수 없음'} - ${item.totalScore}점`;
                        rankingList.appendChild(listItem);
                    });

                } catch (error) {
                    console.error("TOP 4 불러오기 실패:", error);
                    document.getElementById("rankingList").innerHTML = "<li>데이터를 불러오는 데 실패했습니다.</li>";
                }
            }

            document.addEventListener('DOMContentLoaded', fetchTop4Scores);



        //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>2025-02-03 10:40 박청하>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        </script>


    </div>
</div>
</body>
</html>

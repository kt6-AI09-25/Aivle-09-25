<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 90%;
            margin: auto;
        }
        canvas {
            width: 100% !important;
            height: 300px !important;
        }
    </style>
</head>
<body>
<div class="container">
    <canvas id="totalScoreChart"></canvas>
    <canvas id="motionScoreChart"></canvas>
    <canvas id="expressionScoreChart"></canvas>
    <canvas id="languageScoreChart"></canvas>
</div>

<script>
    async function fetchData() {
        const urlParams = new URLSearchParams(window.location.search);
        const scoreId = urlParams.get('scoreId');

        if (!scoreId) {
            alert("Please enter a Score ID and click Load Graph.");
            return;
        }

        const response = await fetch('/scores/all');
        const scores = await response.json();

        // 특정 scoreId의 점수 가져오기
        const specificScore = scores.find(s => s.scoreId == scoreId);
        if (!specificScore) {
            alert("Invalid scoreId!");
            return;
        }

        function groupScores(scores, maxScore) {
            const bins = new Array(Math.floor(maxScore / 5) + 1).fill(0);
            scores.forEach(score => {
                bins[Math.floor(score / 5)] += 1;
            });
            return bins;
        }

        const totalScores = scores.map(s => s.totalScore);
        const motionScores = scores.map(s => s.motionScore);
        const expressionScores = scores.map(s => s.expressionScore);
        const languageScores = scores.map(s => s.languageScore);

        const groupedTotalScores = groupScores(totalScores, 300);
        const groupedMotionScores = groupScores(motionScores, 100);
        const groupedExpressionScores = groupScores(expressionScores, 100);
        const groupedLanguageScores = groupScores(languageScores, 100);

        const totalLabels = Array.from({ length: 61 }, (_, i) => i * 5);  // 0~300
        const otherLabels = Array.from({ length: 21 }, (_, i) => i * 5);  // 0~100

        function roundToNearestFive(score) {
            return Math.round(score / 5) * 5;
        }

        const highlightedTotal = roundToNearestFive(specificScore.totalScore);
        const highlightedMotion = roundToNearestFive(specificScore.motionScore);
        const highlightedExpression = roundToNearestFive(specificScore.expressionScore);
        const highlightedLanguage = roundToNearestFive(specificScore.languageScore);

        function getBarColors(labels, highlightedValue) {
            return labels.map(label => (label === highlightedValue ? 'red' : 'rgba(54, 162, 235, 0.5)'));
        }

        function createHistogram(canvasId, labels, data, highlightedValue, labelName) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelName,
                        data: data,
                        backgroundColor: getBarColors(labels, highlightedValue), // 특정 점수 바 강조
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            ticks: { stepSize: 5 }
                        },
                        y: { beginAtZero: true }
                    },
                    barPercentage: 0.5,
                    categoryPercentage: 0.5
                }
            });
        }

        createHistogram("totalScoreChart", totalLabels, groupedTotalScores, highlightedTotal, "Total Score");
        createHistogram("motionScoreChart", otherLabels, groupedMotionScores, highlightedMotion, "Motion Score");
        createHistogram("expressionScoreChart", otherLabels, groupedExpressionScores, highlightedExpression, "Expression Score");
        createHistogram("languageScoreChart", otherLabels, groupedLanguageScores, highlightedLanguage, "Language Score");
    }

    fetchData();
</script>
</body>
</html>

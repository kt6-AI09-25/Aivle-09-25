<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 90%;
            margin: auto;
        }
        canvas {
            width: 100% !important;
            height: 300px !important;
        }
    </style>
</head>
<body>
<div class="container">
    <canvas id="totalScoreChart"></canvas>
    <canvas id="motionScoreChart"></canvas>
    <canvas id="expressionScoreChart"></canvas>
    <canvas id="languageScoreChart"></canvas>
</div>
<div class="container">
    <canvas id="totalScoreKDE"></canvas>
    <canvas id="motionScoreKDE"></canvas>
    <canvas id="expressionScoreKDE"></canvas>
    <canvas id="languageScoreKDE"></canvas>
</div>

<script>
    async function fetchData() {
        const urlParams = new URLSearchParams(window.location.search);
        const scoreId = urlParams.get('scoreId');

        if (!scoreId) {
            alert("Please enter a Score ID and click Load Graph.");
            return;
        }

        const response = await fetch('/scores/all');
        const scores = await response.json();
        const specificScore = scores.find(s => s.scoreId == scoreId);

        if (!specificScore) {
            alert("Invalid scoreId!");
            return;
        }

        function gaussianKernelDensityEstimation(data, bandwidth) {
            const kernel = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
            const min = 0; // 0으로 시작하도록 고정
            const max = Math.max(...data);
            const points = Array.from({ length: 100 }, (_, i) => min + (max - min) * i / 99);
            const density = points.map(p => data.reduce((sum, d) => sum + kernel((p - d) / bandwidth), 0) / (data.length * bandwidth));
            return { points, density };
        }

        function createHistogram(canvasId, labels, data, highlightedValue, labelName) {
            new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelName,
                        data: labels.map(label => data.filter(score => Math.floor(score / 5) * 5 === label).length),
                        backgroundColor: labels.map(label => (label === highlightedValue ? 'red' : 'rgba(54, 162, 235, 0.5)')),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { type: 'category' }, y: { beginAtZero: true } }
                }
            });
        }

        function createKDEChart(canvasId, data, labelName) {
            const kde = gaussianKernelDensityEstimation(data, 5);
            new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'line',
                data: {
                    labels: kde.points,
                    datasets: [{
                        label: labelName,
                        data: kde.density,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { type: 'linear' }, y: { beginAtZero: true } }
                }
            });
        }

        const totalScores = scores.map(s => s.totalScore);
        const motionScores = scores.map(s => s.motionScore);
        const expressionScores = scores.map(s => s.expressionScore);
        const languageScores = scores.map(s => s.languageScore);

        createHistogram("totalScoreChart", Array.from({ length: 61 }, (_, i) => i * 5), totalScores, Math.round(specificScore.totalScore / 5) * 5, "Total Score");
        createHistogram("motionScoreChart", Array.from({ length: 21 }, (_, i) => i * 5), motionScores, Math.round(specificScore.motionScore / 5) * 5, "Motion Score");
        createHistogram("expressionScoreChart", Array.from({ length: 21 }, (_, i) => i * 5), expressionScores, Math.round(specificScore.expressionScore / 5) * 5, "Expression Score");
        createHistogram("languageScoreChart", Array.from({ length: 21 }, (_, i) => i * 5), languageScores, Math.round(specificScore.languageScore / 5) * 5, "Language Score");

        createKDEChart("totalScoreKDE", totalScores, "Total Score KDE");
        createKDEChart("motionScoreKDE", motionScores, "Motion Score KDE");
        createKDEChart("expressionScoreKDE", expressionScores, "Expression Score KDE");
        createKDEChart("languageScoreKDE", languageScores, "Language Score KDE");
    }

    fetchData();
</script>
</body>
</html>

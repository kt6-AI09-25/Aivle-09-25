<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°œí‘œ ë…¹í™” ë° ë¶„ì„</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ */
    .video-container {
      position: relative;
      display: block;
      margin: 20px auto;
      width: 900px;
      height: 500px;
      border: 2px solid black;
    }
    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }
    /* ë¡œë”© í™”ë©´ */
    #loadingModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      text-align: center;
      padding-top: 20%;
      font-size: 24px;
    }
    /* ì¹´ìš´íŠ¸ë‹¤ìš´ */
    #countdownOverlay {
      display: none;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      font-weight: bold;
      color: #ccc;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      z-index: 10;
    }
    /* íƒ€ì´ë¨¸ */
    #timerOverlay {
      display: none;
      position: absolute;
      top: 10px; right: 10px;
      font-size: 24px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 10;
    }
    /* ë²„íŠ¼ ì»¨íŠ¸ë¡¤ */
    .controls {
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<!-- ë¡œë”© í™”ë©´ -->
<div id="loadingModal">ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</div>

<!-- ë¹„ë””ì˜¤ ì˜ì—­ -->
<div class="video-container">
  <video id="myVideo" autoplay playsinline muted></video>
  <div id="countdownOverlay">3</div>
  <div id="timerOverlay">00:00</div>
</div>

<!-- ë²„íŠ¼ ì»¨íŠ¸ë¡¤ -->
<div class="controls">
  <button id="startBtn">ë°œí‘œ ì‹œì‘</button>
  <button id="stopBtn" disabled>ë°œí‘œ ì¤‘ì§€</button>
  <button id="viewResultsBtn">ë¶„ì„ ê²°ê³¼ ë³´ê¸°</button>
</div>

<script>
  let stream;               // ì¹´ë©”ë¼/ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼
  let mediaRecorder;        // MediaRecorder ê°ì²´
  let recordedChunks = [];  // ë…¹í™” ë°ì´í„° ì €ì¥
  let timerInterval;
  let seconds = 0;
  let isRecording = false;

  // ìš”ì†Œ ì°¸ì¡°
  const countdownOverlay = document.getElementById('countdownOverlay');
  const timerOverlay = document.getElementById('timerOverlay');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const viewResultsBtn = document.getElementById('viewResultsBtn');
  const loadingModal = document.getElementById('loadingModal');

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
  window.addEventListener('load', async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('myVideo').srcObject = stream;
      console.log("ğŸ¥ ì¹´ë©”ë¼/ë§ˆì´í¬ ì—°ê²° ì™„ë£Œ");
    } catch (error) {
      console.error("ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:", error);
      alert("ì¹´ë©”ë¼/ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  });

  // â³ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘ í›„ ë…¹í™” ì‹œì‘
  async function startPresentation() {
    if (!stream) {
      alert("ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
      return;
    }

    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
    startBtn.disabled = true;
    stopBtn.disabled = true;

    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
    countdownOverlay.style.display = 'block';
    let countdown = 3;
    countdownOverlay.textContent = countdown;

    let countdownInterval = setInterval(() => {
      countdown--;
      countdownOverlay.textContent = countdown;
      if (countdown <= 0) {
        clearInterval(countdownInterval);
        countdownOverlay.style.display = 'none';

        // ë…¹í™” ì‹œì‘
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9,opus' });
        recordedChunks = [];

        mediaRecorder.ondataavailable = event => {
          if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.start();
        isRecording = true;
        console.log("ğŸ”´ ë…¹í™” ì‹œì‘ë¨");

        // íƒ€ì´ë¨¸ ì‹œì‘
        seconds = 0;
        timerOverlay.textContent = "00:00";
        timerOverlay.style.display = 'block';
        timerInterval = setInterval(updateTimer, 1000);

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        stopBtn.disabled = false;
      }
    }, 1000);
  }

  // â¹ ë…¹í™” ì¤‘ì§€
  function stopPresentation() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        console.log("â¹ ë…¹í™” ì¤‘ì§€ë¨");
        clearInterval(timerInterval);
        timerOverlay.style.display = 'none';
        isRecording = false;

        console.log("ë…¹í™”ëœ ë°ì´í„° í¬ê¸°:", recordedChunks.length); // âœ… ë°ì´í„° í¬ê¸° í™•ì¸
        stopBtn.disabled = true;
        startBtn.disabled = false;
    }
}


  // ğŸ“¤ ë…¹í™”ë³¸ ì—…ë¡œë“œ ë° ê²°ê³¼ í˜ì´ì§€ ì´ë™
  async function uploadAndGoToResults() {
    if (recordedChunks.length === 0) {
        alert("ë…¹í™”ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    viewResultsBtn.disabled = true;
    loadingModal.style.display = "block";

    // ğŸ›  Blob ìƒì„± (webm í™•ì¥ì ëª…í™•í•˜ê²Œ ì„¤ì •)
    const blob = new Blob(recordedChunks, { type: "video/webm" });

    // ğŸ›  FormDataì— webm íŒŒì¼ ì˜¬ë°”ë¥´ê²Œ ì¶”ê°€
    const formData = new FormData();
    formData.append("file", blob, "presentation.webm");  // íŒŒì¼ ì´ë¦„ ì¶”ê°€
    formData.append("fileType", "video/webm");  // íŒŒì¼ íƒ€ì… ì¶”ê°€

    console.log("ğŸ“¤ ì—…ë¡œë“œí•  ë°ì´í„°:", formData); // âœ… FormData í™•ì¸

    try {
        // ğŸ”¹ FastAPI ì„œë²„ë¡œ ì—…ë¡œë“œ ìš”ì²­
        const uploadResponse = await fetch("/myresults/upload/results", {
            method: "POST",
            body: formData,
        });

        if (!uploadResponse.ok) throw new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");

        const uploadResult = await uploadResponse.json();
        console.log("âœ… ì—…ë¡œë“œ ì„±ê³µ:", uploadResult);

        // ğŸ”¹ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `/scores/results?uploadedFileId=${uploadResult.fileId}`;
    } catch (error) {
        console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("ë°ì´í„° ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        loadingModal.style.display = "none";
        viewResultsBtn.disabled = false;
    }
}


  // â³ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateTimer() {
    seconds++;
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    timerOverlay.textContent =
      `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  startBtn.addEventListener('click', startPresentation);
  stopBtn.addEventListener('click', stopPresentation);
  viewResultsBtn.addEventListener('click', uploadAndGoToResults);
</script>

</body>
</html>
